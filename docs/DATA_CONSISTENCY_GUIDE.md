# 数据一致性保障机制使用指南

## 概述

本系统实现了完整的数据库与MinIO对象存储之间的数据一致性保障机制，确保文件存储的可靠性和数据完整性。

## 核心功能

### 1. 软删除优化机制

**问题背景：** 直接在数据库或MinIO管理界面删除文件会导致数据不一致。

**解决方案：**
- 数据库优先策略：先执行数据库软删除，再删除MinIO文件
- 异常处理：MinIO删除失败时不回滚数据库操作
- 日志记录：详细记录所有删除操作和异常情况

**代码位置：** `MinioFileUploadServiceImpl.deleteFile()`

### 2. 物理删除功能

**单文件物理删除：**
```http
DELETE /api/files/physical/{fileId}
```
- 权限验证：确保用户只能删除自己的文件
- 完整删除：同时删除MinIO文件、缩略图和数据库记录
- 事务保护：确保操作的原子性

**批量清理过期文件：**
```http
POST /api/files/cleanup-expired?days=30
```
- 批量处理：清理指定天数前的软删除文件
- 性能优化：分批处理大量文件
- 灵活配置：支持自定义清理天数

### 3. 定时清理任务

**每日清理任务：**
- 执行时间：每天凌晨2点
- 清理范围：30天前的软删除文件（可配置）
- 操作内容：删除MinIO文件和数据库记录

**深度清理任务：**
- 执行时间：每周日凌晨3点
- 清理范围：90天前的软删除文件（可配置）
- 操作内容：彻底清理长期积累的冗余数据

**配置项：**
```yaml
app:
  file:
    cleanup:
      enabled: true
      daily-cleanup-days: 30
      weekly-cleanup-days: 90
```

### 4. 数据一致性监控

**自动检查机制：**
- 每小时快速检查：监控数据一致性状态
- 每日详细检查：全面检查并记录问题
- 每周自动修复：自动修复孤立的数据库记录

**手动管理接口：**

**检查数据一致性：**
```http
GET /api/admin/data-consistency/check
```
返回结果包括：
- 孤立数据库记录（数据库有记录但MinIO无文件）
- 孤立MinIO文件（MinIO有文件但数据库无记录）
- 其他不一致情况

**修复数据一致性：**
```http
POST /api/admin/data-consistency/repair?repairOrphanedDbRecords=true
```
修复操作：
- 将孤立的数据库记录标记为已删除
- 保持数据库与MinIO的一致性

**获取一致性状态：**
```http
GET /api/admin/data-consistency/status
```

## 数据不一致的原因和解决方案

### 问题1：直接在数据库删除记录

**现象：** MinIO中存在文件，但数据库中没有对应记录

**影响：** 
- 文件无法通过系统访问
- MinIO存储空间浪费
- 系统数据统计不准确

**解决方案：**
- 监控检测：定时任务会检测到孤立的MinIO文件
- 手动清理：管理员可以通过MinIO控制台手动删除
- 预防措施：禁止直接操作数据库，使用系统提供的API

### 问题2：直接在MinIO管理界面删除文件

**现象：** 数据库中有记录，但MinIO中没有对应文件

**影响：**
- 用户无法下载文件
- 系统报告文件不存在错误
- 数据库记录成为垃圾数据

**解决方案：**
- 自动修复：系统会自动将这些记录标记为已删除
- 手动修复：调用修复API进行批量处理
- 预防措施：通过系统API进行文件删除操作

### 问题3：系统异常导致的不一致

**现象：** 删除操作中途失败，导致部分删除

**解决方案：**
- 数据库优先：确保数据库状态的准确性
- 异常处理：记录失败操作，便于后续处理
- 定时修复：自动检测和修复不一致状态

## 最佳实践

### 1. 文件删除操作

**推荐做法：**
```java
// 使用系统提供的删除API
fileUploadService.deleteFile(fileId, userId);
```

**避免做法：**
- 直接删除数据库记录
- 直接删除MinIO文件
- 绕过权限验证的删除操作

### 2. 数据一致性维护

**定期检查：**
- 每周执行一次手动一致性检查
- 关注监控日志中的警告信息
- 及时处理发现的不一致问题

**配置优化：**
```yaml
app:
  data-consistency:
    monitor:
      enabled: true        # 启用监控
      auto-repair: true    # 启用自动修复
      check-interval-hours: 1  # 检查间隔
```

### 3. 故障处理

**发现不一致时：**
1. 查看系统日志，了解问题原因
2. 使用检查API确认问题范围
3. 根据情况选择自动或手动修复
4. 验证修复结果

**预防措施：**
- 定期备份重要数据
- 监控系统运行状态
- 及时更新和维护系统

## 监控和告警

### 日志监控

**关键日志级别：**
- `ERROR`：删除操作失败、修复失败
- `WARN`：发现数据不一致、部分操作失败
- `INFO`：正常的清理和修复操作

**重要日志关键词：**
- `数据不一致`
- `孤立记录`
- `修复失败`
- `清理失败`

### 性能监控

**关注指标：**
- 文件删除成功率
- 数据一致性检查耗时
- 清理任务执行时间
- 存储空间使用情况

## 配置参考

### 完整配置示例

```yaml
app:
  file:
    cleanup:
      enabled: true
      daily-cleanup-days: 30
      weekly-cleanup-days: 90
  data-consistency:
    monitor:
      enabled: true
      auto-repair: true
      check-interval-hours: 1

# MinIO配置
minio:
  endpoint: http://localhost:9000
  access-key: minioadmin
  secret-key: minioadmin
  bucket:
    files: im-files
    images: im-images
    thumbnails: im-thumbnails
    avatars: im-avatars
    other: im-others
```

### 环境特定配置

**开发环境：**
- 启用详细日志
- 缩短清理周期便于测试
- 启用所有监控功能

**生产环境：**
- 适当的清理周期
- 启用自动修复
- 配置告警通知

## 故障排查

### 常见问题

**Q1：为什么文件删除后仍然占用MinIO空间？**
A1：系统采用软删除机制，文件会在定时任务中被物理删除。可以手动调用清理API立即清理。

**Q2：如何处理大量的数据不一致问题？**
A2：使用批量修复API，分批处理避免系统负载过高。

**Q3：定时任务没有执行怎么办？**
A3：检查`@EnableScheduling`注解是否启用，确认配置项`enabled: true`。

### 调试步骤

1. **检查配置：** 确认相关配置项正确
2. **查看日志：** 分析错误日志和警告信息
3. **手动测试：** 使用API接口进行手动测试
4. **数据验证：** 对比数据库和MinIO的数据状态
5. **逐步修复：** 先小范围测试，再批量处理

## 总结

本数据一致性保障机制通过多层次的保护措施，确保了文件存储系统的可靠性：

1. **预防为主：** 优化删除流程，减少不一致的产生
2. **主动监控：** 定时检查，及时发现问题
3. **自动修复：** 智能修复常见的不一致问题
4. **手动干预：** 提供管理接口处理复杂情况
5. **完整日志：** 详细记录便于问题追踪

通过正确使用这些功能，可以有效避免直接操作数据库或MinIO导致的数据不一致问题，确保系统的稳定运行。